{% extends 'journal/base.html' %}
{% load dict_filters %}
{% block main %}
<h1>{{ st_pk }}</h1>

{% for teacher_subject in st_teacher_subjects %}
    <h3>{{ teacher_subject }}</h3>
    <table>
        {% csrf_token %}
        <tr>
            <th>№</th>
            <th>Студент</th>
            {% for lesson in lessons %}
                {% if teacher_subject == lesson.teacher_subject %}
                    <th class="lesson_date" id="lesson{{ lesson.pk }}" data-lesson-pk="{{ lesson.pk }}" style="position: relative;">
                        <span>{{ lesson.date | date:"d" }}</span>
                    </th>
                {% endif %}
            {% endfor %}
        </tr>
        <tr>
            <td>{{ sequence_numbers |get_value:teacher_subject.pk }}</td>
            <td>{{ student }}</td>
            {% for lesson in lessons %}
                {% if teacher_subject == lesson.teacher_subject %}
                <td>
                    {% for student_lesson in student_lessons %}
                        {% if lesson == student_lesson.lesson %}
                            {{ student_lesson.mark }}
                        {% endif %}
                    {% endfor%}
                </td>
                {% endif %}
            {% endfor %}
        </tr>
    </table>
<hr>
{% endfor %}

<div id="lesson_info" style="background-color: #c4c4c4; border: 1px solid black;">
    <h1><span id="lesson-info-teacher_subject">Предмет</span></h1>
    <p>Останнє оновлення: <span id="lesson-info-last_update">-</span></p>
    <p>Дата проведення пари: <span id="lesson-info-date">-</span></p>
    <p>Тема: <span id="lesson-info-topic">-</span></p>
    <p>Домашнє завдання: <span id="lesson-info-homework">-</span></p>
    <p>Примітка: <span id="lesson-info-note">-</span></p>
    <p>Тип: <span id="lesson-info-type">-</span></p>
</div>

{% endblock %}
{% block script %}
<script>
$(document).ready(function(){
    const months = {{ months|safe }};
    for (let i in months) {
        $(`#lesson${i}`).attr('data-content', months[i]);
    }

    const table_csrf = $("table").find("input[name=csrfmiddlewaretoken]").val();
    $(".lesson_date span").click(function() {
        $("#lesson_info").hide();
        let lesson_pk = $(this).parent().attr('data-lesson-pk')
        $.ajax({
            url: '',
            type: 'post',
            data: {
                csrfmiddlewaretoken: table_csrf,
                type: 'get_lesson_info',
                lesson_pk: lesson_pk,
            },
            success: function(responce) {
                $('#lesson-info-teacher_subject').html(responce.teacher + " " + responce.subject);
                $('#lesson-info-last_update').html(responce.last_update);
                $('#lesson-info-date').html(responce.date);
                $('#lesson-info-topic').html(responce.topic);
                $('#lesson-info-homework').html(responce.homework);
                $('#lesson-info-note').html(responce.note);
                $('#lesson-info-type').html(responce.type);
                $("#lesson_info").show();
            }
        });
    });
});
</script>
{% endblock %}